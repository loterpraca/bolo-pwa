<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Lançamento de Bolões</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --txt:#121826;
      --muted:#6b7280;
      --line:#e5e7eb;
      --btn:#111827;
      --btn2:#2563eb;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow:0 10px 25px rgba(0,0,0,.07);
      --radius:16px;
      --pad:14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--txt);
      background:var(--bg);
    }
    .wrap{
      max-width:920px;
      margin:0 auto;
      padding:14px 12px 90px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
    }
    .title{
      font-size:20px;
      font-weight:800;
      letter-spacing:.2px;
      margin:0;
    }
    .chip{
      font-size:12px;
      color:var(--muted);
      background:#fff;
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:var(--pad);
      margin:10px 0;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .field label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px 2px;
    }
    .field input, .field select{
      width:100%;
      font-size:16px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
      line-height:1.35;
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-size:16px;
      font-weight:700;
      cursor:pointer;
      min-height:46px;
    }
    .btn-primary{ background:var(--btn2); color:#fff; flex:1; }
    .btn-dark{ background:var(--btn); color:#fff; flex:1; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--line); color:var(--txt); }
    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed var(--line);
      background:#fff;
      font-size:14px;
      line-height:1.35;
      white-space:pre-line;
    }
    .ok{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.06); }
    .err{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.06); }
    .muted{ color:var(--muted); }

    .sectionTitle{
      font-size:14px;
      font-weight:800;
      margin:0 0 10px;
    }

    .miniGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .footerBar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:#ffffffcc;
      backdrop-filter: blur(10px);
      border-top:1px solid var(--line);
      padding:10px 12px;
    }
    .footerInner{
      max-width:920px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .small{
      font-size:12px;
      color:var(--muted);
    }

    @media (max-width:720px){
      .grid, .grid3{ grid-template-columns: 1fr; }
      .footerInner{ flex-direction:column; align-items:flex-start; }
      .title{ font-size:18px; }
      .field input, .field select{ font-size:17px; }
      button{ font-size:17px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1 class="title">Lançamento de Bolões</h1>
      <div class="chip" id="pwaChip">PWA: verificando…</div>
    </header>

    <div class="card">
      <p class="sectionTitle">Dados do bolão</p>

      <div class="grid">
        <div class="field">
          <label>Loja de origem (obrigatório)</label>
          <select id="lojaOrigem" required>
            <option value="">Selecione…</option>
            <option>Centro</option>
            <option>Lotobel</option>
            <option>Boulevard</option>
            <option>Santa Tereza</option>
          </select>
        </div>

        <div class="field">
          <label>Modalidade (obrigatório)</label>
          <select id="modalidade" required>
            <option value="">Selecione…</option>
            <option>Mega Sena</option>
            <option>Lotofácil</option>
            <option>Quina</option>
            <option>Dupla Sena</option>
            <option>Dia de Sorte</option>
            <option>Super Sete</option>
            <option>+Milionária</option>
            <option>Timemania</option>
            <option>Lotomania</option>
            <option>Federal</option>

            <!-- Especiais -->
            <option>Páscoa</option>
            <option>São João</option>
            <option>Independência</option>
            <option>Virada</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Concurso (obrigatório)</label>
          <input id="concurso" inputmode="numeric" placeholder="Ex: 3890" required />
        </div>

        <div class="field">
          <label>Valor da cota (R$) (obrigatório)</label>
          <input id="valorCota" inputmode="decimal" placeholder="Ex: 112,44" required />
        </div>
      </div>

      <!-- Datas lado a lado -->
      <div class="miniGrid">
        <div class="field">
          <label>Data inicial (obrigatório)</label>
          <input id="dataInicial" type="date" required />
        </div>
        <div class="field">
          <label>Data do concurso (obrigatório)</label>
          <input id="dataConcurso" type="date" required />
        </div>
      </div>

      <div class="grid3">
        <div class="field">
          <label>Qtd de Jogos (obrigatório)</label>
          <input id="qtdJogos" inputmode="numeric" placeholder="Ex: 7" required />
        </div>

        <div class="field">
          <label>Qtd de Dezenas (obrigatório)</label>
          <input id="qtdDezenas" inputmode="numeric" placeholder="Ex: 17" required />
        </div>

        <div class="field">
          <label>Qtde de Cotas (obrigatório)</label>
          <input id="cotas" inputmode="numeric" placeholder="Ex: 38" required />
        </div>
      </div>

      <div class="actions">
        <button class="btn-primary" id="btnCadastrar">Cadastrar / Somar cotas</button>
        <button class="btn-danger" id="btnDeletar" title="Deleta o bolão (envia -999)">Deletar bolão</button>
        <button class="btn-ghost" id="btnLimpar">Limpar</button>
      </div>

      <div class="hint">
        Regra do seu script: ao cadastrar, se <b>modalidade + concurso + valor da cota</b> forem iguais, ele <b>soma as cotas</b>
        mesmo que <b>qtd de jogos/dezenas</b> sejam diferentes.
      </div>

      <div id="status" class="status muted">Pronto.</div>
    </div>

    <div class="card">
      <p class="sectionTitle">Movimentar (Controle) — E4:E7</p>

      <div class="grid">
        <div class="field">
          <label>Adicionar / Subtrair para Boulevard (E4)</label>
          <input id="deltaBoulevard" inputmode="numeric" placeholder="Ex: 10 ou -10" />
        </div>
        <div class="field">
          <label>Adicionar / Subtrair para Centro (E5)</label>
          <input id="deltaCentro" inputmode="numeric" placeholder="Ex: 10 ou -10" />
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Adicionar / Subtrair para Lotobel (E6)</label>
          <input id="deltaLotobel" inputmode="numeric" placeholder="Ex: 10 ou -10" />
        </div>
        <div class="field">
          <label>Adicionar / Subtrair para Santa Tereza (E7)</label>
          <input id="deltaSantaTereza" inputmode="numeric" placeholder="Ex: 10 ou -10" />
        </div>
      </div>

      <div class="actions">
        <button class="btn-dark" id="btnMovimentar">Movimentar</button>
        <button class="btn-ghost" id="btnZerarMov">Zerar E4:E7</button>
      </div>

      <div class="hint">
        Movimentar cria uma linha se não existir e soma na linha se já existir (por origem+destino+modalidade+concurso+valor).
      </div>
    </div>
  </div>

  <div class="footerBar">
    <div class="footerInner">
      <div class="small">
        GitHub Pages + PWA. API Apps Script (exec).
      </div>
      <button class="btn-ghost" id="btnPing">Testar API (ping)</button>
    </div>
  </div>

<script>
  /********************************************************
   * CONFIG
   ********************************************************/
  const API_URL = "https://script.google.com/macros/s/AKfycbzzcSuw9vt8GHBpmIWUYY6AoVEwef9jiIMLRLMWdZcpoVJzNLLStDepu096nrQu80Fl/exec";

  /********************************************************
   * HELPERS UI
   ********************************************************/
  const $ = (id) => document.getElementById(id);

  function setStatus(msg, type="muted"){
    const el = $("status");
    el.classList.remove("ok","err","muted");
    el.classList.add(type);
    el.textContent = msg;
  }

  function onlyDigits(v){ return String(v||"").replace(/[^\d\-]/g,""); }

  function parseBRMoneyToNumber(v){
    if (v == null) return 0;
    const s = String(v).trim();
    if (!s) return 0;
    // remove R$, espaços, milhar
    const cleaned = s.replace(/[R$\s]/g,"").replace(/\./g,"").replace(",",".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function base64Json(obj){
    const json = JSON.stringify(obj);
    // btoa com utf-8 seguro
    return btoa(unescape(encodeURIComponent(json)));
  }

  // JSONP para evitar CORS no Apps Script
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName;

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout na chamada da API."));
      }, 25000);

      function cleanup(){
        clearTimeout(timer);
        delete window[cbName];
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cbName] = (data) => {
        cleanup();
        resolve(data);
      };

      s.onerror = () => {
        cleanup();
        reject(new Error("Falha carregando JSONP (script)."));
      };

      document.body.appendChild(s);
    });
  }

  function saveDraft(){
    const draft = {
      lojaOrigem: $("lojaOrigem").value,
      modalidade: $("modalidade").value,
      concurso: $("concurso").value,
      dataInicial: $("dataInicial").value,
      dataConcurso: $("dataConcurso").value,
      qtdJogos: $("qtdJogos").value,
      qtdDezenas: $("qtdDezenas").value,
      cotas: $("cotas").value,
      valorCota: $("valorCota").value,
      deltaBoulevard: $("deltaBoulevard").value,
      deltaCentro: $("deltaCentro").value,
      deltaLotobel: $("deltaLotobel").value,
      deltaSantaTereza: $("deltaSantaTereza").value
    };
    localStorage.setItem("bolo_draft", JSON.stringify(draft));
  }

  function loadDraft(){
    try{
      const raw = localStorage.getItem("bolo_draft");
      if(!raw) return;
      const d = JSON.parse(raw);
      $("lojaOrigem").value = d.lojaOrigem || "";
      $("modalidade").value = d.modalidade || "";
      $("concurso").value = d.concurso || "";
      $("dataInicial").value = d.dataInicial || "";
      $("dataConcurso").value = d.dataConcurso || "";
      $("qtdJogos").value = d.qtdJogos || "";
      $("qtdDezenas").value = d.qtdDezenas || "";
      $("cotas").value = d.cotas || "";
      $("valorCota").value = d.valorCota || "";
      $("deltaBoulevard").value = d.deltaBoulevard || "";
      $("deltaCentro").value = d.deltaCentro || "";
      $("deltaLotobel").value = d.deltaLotobel || "";
      $("deltaSantaTereza").value = d.deltaSantaTereza || "";
    }catch(e){}
  }

  function clearMain(){
    $("modalidade").value = "";
    $("concurso").value = "";
    $("dataInicial").value = "";
    $("dataConcurso").value = "";
    $("qtdJogos").value = "";
    $("qtdDezenas").value = "";
    $("cotas").value = "";
    $("valorCota").value = "";
    saveDraft();
  }

  function clearMov(){
    $("deltaBoulevard").value = "";
    $("deltaCentro").value = "";
    $("deltaLotobel").value = "";
    $("deltaSantaTereza").value = "";
    saveDraft();
  }

  function validateBase(requiredCotas=true){
    const lojaOrigem = $("lojaOrigem").value.trim();
    const modalidade = $("modalidade").value.trim();
    const concurso = $("concurso").value.trim();
    const dataInicial = $("dataInicial").value;
    const dataConcurso = $("dataConcurso").value;
    const qtdJogos = Number(onlyDigits($("qtdJogos").value));
    const qtdDezenas = Number(onlyDigits($("qtdDezenas").value));
    const cotas = Number(onlyDigits($("cotas").value));
    const valorCota = parseBRMoneyToNumber($("valorCota").value);

    if(!lojaOrigem) throw new Error("Loja de origem é obrigatória.");
    if(!modalidade) throw new Error("Modalidade é obrigatória.");
    if(!concurso) throw new Error("Concurso é obrigatório.");
    if(!dataInicial) throw new Error("Data inicial é obrigatória.");
    if(!dataConcurso) throw new Error("Data do concurso é obrigatória.");
    if(!qtdJogos || qtdJogos <= 0) throw new Error("Qtd de Jogos deve ser > 0.");
    if(!qtdDezenas || qtdDezenas <= 0) throw new Error("Qtd de Dezenas deve ser > 0.");
    if(requiredCotas && (!Number.isFinite(cotas) || cotas === 0)) throw new Error("Qtde de Cotas é obrigatória (≠ 0).");
    if(!valorCota || valorCota <= 0) throw new Error("Valor da cota deve ser > 0.");

    return { lojaOrigem, modalidade, concurso, dataInicial, dataConcurso, qtdJogos, qtdDezenas, cotas, valorCota };
  }

  function getMovDeltas(){
    const deltaBoulevard = Number(onlyDigits($("deltaBoulevard").value || "0")) || 0;
    const deltaCentro = Number(onlyDigits($("deltaCentro").value || "0")) || 0;
    const deltaLotobel = Number(onlyDigits($("deltaLotobel").value || "0")) || 0;
    const deltaSantaTereza = Number(onlyDigits($("deltaSantaTereza").value || "0")) || 0;
    return { deltaBoulevard, deltaCentro, deltaLotobel, deltaSantaTereza };
  }

  async function callApi(action, payloadObj){
    const payload = base64Json(payloadObj || {});
    const url = `${API_URL}?action=${encodeURIComponent(action)}&payload=${encodeURIComponent(payload)}`;
    return await jsonp(url);
  }

  /********************************************************
   * ACTIONS
   ********************************************************/
  async function onCadastrar(){
    try{
      setStatus("Enviando…");
      const base = validateBase(true);

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: base.qtdJogos,
        qtdDezenas: base.qtdDezenas,
        cotas: base.cotas,
        valorCota: base.valorCota
      };

      saveDraft();
      const res = await callApi("cadastrar", payload);

      if(res && res.ok){
        setStatus(res.message || "OK!", "ok");
      }else{
        setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
      }
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onDeletar(){
    try{
      setStatus("Enviando deleção…");
      const base = validateBase(false);

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: Number(onlyDigits($("qtdJogos").value)) || 1,
        qtdDezenas: Number(onlyDigits($("qtdDezenas").value)) || 1,
        cotas: -999,
        valorCota: base.valorCota
      };

      saveDraft();
      const res = await callApi("cadastrar", payload);

      if(res && res.ok){
        setStatus(res.message || "OK!", "ok");
      }else{
        setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
      }
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onMovimentar(){
    try{
      setStatus("Enviando movimentação…");
      const base = validateBase(false);
      const deltas = getMovDeltas();
      if(!deltas.deltaBoulevard && !deltas.deltaCentro && !deltas.deltaLotobel && !deltas.deltaSantaTereza){
        throw new Error("Informe pelo menos um destino com valor diferente de zero (E4:E7).");
      }

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: Number(onlyDigits($("qtdJogos").value)),
        qtdDezenas: Number(onlyDigits($("qtdDezenas").value)),
        valorCota: base.valorCota,
        deltaBoulevard: deltas.deltaBoulevard,
        deltaCentro: deltas.deltaCentro,
        deltaLotobel: deltas.deltaLotobel,
        deltaSantaTereza: deltas.deltaSantaTereza
      };

      saveDraft();
      const res = await callApi("movimentar", payload);

      if(res && res.ok){
        setStatus(res.message || "OK!", "ok");
        // zera deltas na tela (igual você pediu)
        clearMov();
      }else{
        setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
      }
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onPing(){
    try{
      setStatus("Ping…");
      const res = await callApi("ping", {});
      if(res && res.ok){
        setStatus(`OK! ${res.message}\n${res.ts || ""}`, "ok");
      }else{
        setStatus((res && res.message) ? res.message : "Falha no ping.", "err");
      }
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  /********************************************************
   * INIT
   ********************************************************/
  function bind(){
    const inputs = document.querySelectorAll("input,select");
    inputs.forEach(el => el.addEventListener("change", saveDraft));
    inputs.forEach(el => el.addEventListener("keyup", saveDraft));

    $("btnCadastrar").addEventListener("click", onCadastrar);
    $("btnDeletar").addEventListener("click", onDeletar);
    $("btnMovimentar").addEventListener("click", onMovimentar);

    $("btnLimpar").addEventListener("click", () => { clearMain(); setStatus("Campos limpos.", "muted"); });
    $("btnZerarMov").addEventListener("click", () => { clearMov(); setStatus("Movimentação zerada.", "muted"); });

    $("btnPing").addEventListener("click", onPing);
  }

  function setPwaChip(){
    const el = $("pwaChip");
    const isStandalone = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;
    el.textContent = isStandalone ? "PWA: instalado" : "PWA: navegador";
  }

  loadDraft();
  bind();
  setPwaChip();
  window.addEventListener("visibilitychange", setPwaChip);

  /********************************************************
   * SERVICE WORKER
   ********************************************************/
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      <script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./service-worker.js", { updateViaCache: "none" });
        // força atualizar agora
        await reg.update();
      } catch (e) {}
    });
  }
</script>
        .then(() => setPwaChip())
        .catch(() => {});
    });
  }
</script>
</body>
</html>
