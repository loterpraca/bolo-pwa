<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Sistema de Bolões</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#4f46e5">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <style>
    :root{
      --primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#818cf8;--secondary:#f59e0b;
      --bg:#f8fafc;--card:#fff;--txt:#0f172a;--muted:#64748b;--label:#334155;--line:#e2e8f0;
      --success:#10b981;--danger:#ef4444;--warning:#f59e0b;
      --shadow:0 10px 25px rgba(0,0,0,.08);--shadow-lg:0 20px 50px rgba(0,0,0,.12);
      --radius:16px;--radius-sm:12px;--pad:16px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      --transition:all .25s cubic-bezier(.4,0,.2,1);
    }

    [data-theme="boulevard"]{--primary:#4682B4;--primary-dark:#2563eb;--primary-light:#60a5fa;--secondary:#f97316;}
    [data-theme="centro"]{--primary:#2E8B57;--primary-dark:#16a34a;--primary-light:#4ade80;--secondary:#eab308;}
    [data-theme="lotobel"]{--primary:#CD5C5C;--primary-dark:#b91c1c;--primary-light:#ef4444;--secondary:#d97706;}
    [data-theme="santa-tereza"]{--primary:#483D8B;--primary-dark:#7e22ce;--primary-light:#a855f7;--secondary:#f59e0b;}

    *{box-sizing:border-box;margin:0;padding:0}
    body{margin:0;font-family:var(--font);color:var(--txt);background:var(--bg);min-height:100vh;transition:var(--transition)}

    /* HEADER compacto + avatar circular */
    .header{
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      color:#fff;padding:10px 12px;box-shadow:var(--shadow);
      position:sticky;top:0;z-index:100;
    }
    .header-content{max-width:920px;margin:0 auto;display:flex;align-items:center;gap:12px}

    /* Logo circular (estilo Google) */
    .logo-container{
      width:58px;height:58px;background:#fff;border-radius:50%;
      padding:0;box-shadow:0 6px 16px rgba(0,0,0,.18);
      display:flex;align-items:center;justify-content:center;overflow:hidden;flex:0 0 auto
    }
    .logo-container img{
      width:122%;height:122%;
      object-fit:cover;object-position:center;
    }

    .header-title{flex:1;min-width:0}
    .header-title h1{
      font-size:17px;font-weight:900;line-height:1.05;margin:0 0 2px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    .header-title p{
      font-size:12px;opacity:.9;margin:0;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }

    /* 4 logos topo */
    .brand-logos{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex:0 0 auto}
    .brand-logos button{
      border:0;background:rgba(255,255,255,.14);
      width:34px;height:34px;border-radius:12px;display:grid;place-items:center;cursor:pointer;
      transition:var(--transition);padding:0
    }
    .brand-logos button:hover{transform:translateY(-1px);background:rgba(255,255,255,.22)}
    .brand-logos button.active{outline:2px solid rgba(255,255,255,.55);background:rgba(255,255,255,.24)}
    .brand-logos img{width:22px;height:22px;object-fit:contain;filter:drop-shadow(0 1px 2px rgba(0,0,0,.15))}

    .wrap{max-width:920px;margin:0 auto;padding:14px 12px 88px}

    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      box-shadow:var(--shadow);padding:var(--pad);margin:12px 0;transition:var(--transition)
    }
    .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-1px)}

    .section-header{
      display:flex;align-items:center;gap:10px;margin-bottom:14px;padding-bottom:10px;border-bottom:2px solid var(--primary)
    }
    .section-icon{
      width:34px;height:34px;border-radius:10px;
      background:linear-gradient(135deg,var(--primary),var(--primary-dark));
      display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;flex:0 0 auto
    }
    .section-title{
      font-size:16px;font-weight:900;margin:0;color:var(--txt);
      display:flex;align-items:center;gap:10px;flex-wrap:wrap
    }

    /* ✅ MOVIMENTAR: texto alinhado ao lado do ícone (sem “quebrar”) */
    .section-title.inline-title{
      align-items:center;
    }

    /* GRIDS */
    .grid-1{display:grid;grid-template-columns:1fr;gap:12px}
    .grid-2{display:grid;grid-template-columns:minmax(0,1fr) minmax(0,1fr);gap:12px;margin-top:12px}

    /* ✅ força 2 colunas mesmo no celular (para MOVIMENTAÇÃO) */
    .force-2{grid-template-columns:minmax(0,1fr) minmax(0,1fr)!important}

    .field label{
      display:flex;align-items:center;gap:6px;font-size:12px;color:var(--label);
      font-weight:800;margin:0 0 6px 2px
    }
    .field label i{color:var(--primary);font-size:13px}
    .field input,.field select{
      width:100%;font-size:16px;padding:12px 14px;border-radius:var(--radius-sm);
      border:2px solid var(--line);outline:none;background:#fff;transition:var(--transition);font-family:var(--font)
    }
    .field input:focus,.field select:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,.10);transform:translateY(-1px)}
    .field input:disabled{background:#f1f5f9;color:#94a3b8;cursor:not-allowed;opacity:.75}

    /* Chip origem */
    .mov-origem{
      display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;
      background:rgba(0,0,0,.06);color:var(--txt);font-size:12px;font-weight:900;
      border:1px solid var(--line)
    }
    .mov-origem i{color:var(--primary)}

    /* Ações */
    .actions-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px;margin-top:14px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}

    button{
      border:0;border-radius:var(--radius-sm);
      padding:12px 14px;font-size:15px;font-weight:900;cursor:pointer;min-height:48px;
      transition:var(--transition);font-family:var(--font);
      display:flex;align-items:center;justify-content:center;gap:8px;position:relative;overflow:hidden
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;box-shadow:0 4px 12px rgba(99,102,241,.25)}
    .btn-primary:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px rgba(99,102,241,.32)}
    .btn-dark{background:linear-gradient(135deg,#1e293b,#0f172a);color:#fff;box-shadow:0 4px 12px rgba(15,23,42,.25)}
    .btn-dark:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px rgba(15,23,42,.32)}
    .btn-danger{background:linear-gradient(135deg,var(--danger),#dc2626);color:#fff;box-shadow:0 4px 12px rgba(239,68,68,.25)}
    .btn-danger:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 20px rgba(239,68,68,.32)}
    .btn-ghost{background:#fff;border:2px solid var(--line);color:var(--txt)}
    .btn-ghost:hover:not(:disabled){border-color:var(--primary);color:var(--primary);transform:translateY(-1px)}

    .btn-loading{pointer-events:none;opacity:.75}
    .btn-loading::after{
      content:"";position:absolute;width:16px;height:16px;border:2px solid rgba(255,255,255,.35);
      border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Status: sozinho (linha inteira) */
    .status{
      margin-top:12px;padding:12px 14px;border-radius:var(--radius-sm);
      font-size:13px;line-height:1.45;display:flex;align-items:flex-start;gap:10px
    }
    .status i{font-size:16px;margin-top:1px}
    .status.muted{background:#f1f5f9;border:2px solid #e2e8f0;color:var(--muted)}
    .status.ok{background:#dcfce7;border:2px solid #86efac;color:#15803d}
    .status.ok i{color:var(--success)}
    .status.err{background:#fee2e2;border:2px solid #fca5a5;color:#991b1b}
    .status.err i{color:var(--danger)}

    /* Modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
    .modal-overlay.active{display:flex}
    .modal{background:#fff;border-radius:var(--radius);padding:20px;max-width:520px;width:92%;box-shadow:0 25px 50px rgba(0,0,0,.3)}
    .modal-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .modal-icon{width:44px;height:44px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;background:linear-gradient(135deg,var(--warning),#f59e0b);color:#fff;flex:0 0 auto}
    .modal-title{font-size:18px;font-weight:900;color:var(--txt)}
    .modal-body{color:var(--muted);line-height:1.55;margin-bottom:16px;white-space:pre-line;font-size:14px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end}

    /* Mobile fino: mantém layout, só reduz topo */
    @media (max-width:720px){
      .wrap{padding:12px 10px 92px}
      .logo-container{width:60px;height:60px}
      .logo-container img{width:124%;height:124%}
      .actions-3{grid-template-columns:1fr} /* botões empilham no celular */
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <div class="logo-container" title="Loja selecionada">
        <img src="./icons/loterpraca.png" alt="Logo" id="logoImg" />
      </div>

      <div class="header-title">
        <h1 id="headerTitle">Sistema de Bolões</h1>
        <p id="headerSub">Cadastro e movimentação</p>
      </div>

      <div class="brand-logos" aria-label="Atalhos das lojas">
        <button type="button" class="brand-btn" data-loja="Boulevard" title="Boulevard">
          <img src="./icons/boulevard.jpg" alt="Boulevard">
        </button>
        <button type="button" class="brand-btn" data-loja="Centro" title="Centro">
          <img src="./icons/loterpraca.png" alt="Centro">
        </button>
        <button type="button" class="brand-btn" data-loja="Lotobel" title="Lotobel">
          <img src="./icons/lotobel.jpg" alt="Lotobel">
        </button>
        <button type="button" class="brand-btn" data-loja="Santa Tereza" title="Santa Tereza">
          <img src="./icons/santa-tereza.png" alt="Santa Tereza">
        </button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <!-- DADOS -->
    <div class="card">
      <div class="section-header">
        <div class="section-icon"><i class="fas fa-ticket-alt"></i></div>
        <h2 class="section-title">Dados do bolão</h2>
      </div>

      <!-- Loja de Origem sozinho -->
      <div class="grid-1">
        <div class="field">
          <label><i class="fas fa-store"></i> Loja de origem</label>
          <select id="lojaOrigem" required>
            <option value="">Selecione a loja…</option>
            <option>Boulevard</option>
            <option>Centro</option>
            <option>Lotobel</option>
            <option>Santa Tereza</option>
          </select>
        </div>
      </div>

      <!-- Modalidade + Concurso -->
      <div class="grid-2">
        <div class="field">
          <label><i class="fas fa-clover"></i> Modalidade</label>
          <select id="modalidade" required>
            <option value="">Selecione…</option>
            <option>Mega Sena</option>
            <option>Lotofacil</option>
            <option>Quina</option>
            <option>Dupla Sena</option>
            <option>Dia de Sorte</option>
            <option>Super Sete</option>
            <option>Milionaria</option>
            <option>Timemania</option>
            <option>Lotomania</option>
            <option>Federal</option>
            <option>Pascoa</option>
            <option>Sao Joao</option>
            <option>Independencia</option>
            <option>Virada</option>
          </select>
        </div>

        <div class="field">
          <label><i class="fas fa-hashtag"></i> Concurso</label>
          <input id="concurso" inputmode="numeric" placeholder="Ex: 2654" required />
        </div>
      </div>

      <!-- Data inicial + Data concurso -->
      <div class="grid-2">
        <div class="field">
          <label><i class="fas fa-calendar-day"></i> Data inicial</label>
          <input id="dataInicial" type="date" required />
        </div>
        <div class="field">
          <label><i class="fas fa-calendar-check"></i> Data do concurso</label>
          <input id="dataConcurso" type="date" required />
        </div>
      </div>

      <!-- Qtd de Jogos + Qtd de Dezenas -->
      <div class="grid-2">
        <div class="field">
          <label><i class="fas fa-list-ol"></i> Qtd de Jogos</label>
          <input id="qtdJogos" inputmode="numeric" placeholder="Ex: 10" required />
        </div>
        <div class="field">
          <label><i class="fas fa-dice"></i> Qtd de Dezenas</label>
          <input id="qtdDezenas" inputmode="numeric" placeholder="Ex: 6" required />
        </div>
      </div>

      <!-- Valor da cota + Qtd de Cotas -->
      <div class="grid-2">
        <div class="field">
          <label><i class="fas fa-money-bill-wave"></i> Valor da cota (R$)</label>
          <input id="valorCota" inputmode="decimal" placeholder="Ex: 15,00" required />
        </div>
        <div class="field">
          <label><i class="fas fa-users"></i> Qtd de Cotas</label>
          <input id="cotas" inputmode="numeric" placeholder="Ex: 50" required />
        </div>
      </div>

      <!-- Cadastrar / Limpar / Deletar -->
      <div class="actions-3">
        <button type="button" class="btn-primary" id="btnCadastrar">
          <i class="fas fa-check"></i><span>Cadastrar</span>
        </button>
        <button type="button" class="btn-ghost" id="btnLimpar">
          <i class="fas fa-eraser"></i><span>Limpar</span>
        </button>
        <button type="button" class="btn-danger" id="btnDeletar" title="Deleta o bolão (envia -999)">
          <i class="fas fa-trash"></i><span>Deletar</span>
        </button>
      </div>

      <!-- Status sozinho -->
      <div id="status" class="status muted">
        <i class="fas fa-info-circle"></i>
        <span>Preencha os campos acima para cadastrar um bolão.</span>
      </div>
    </div>

    <!-- MOVIMENTAR -->
    <div class="card">
      <div class="section-header">
        <div class="section-icon"><i class="fas fa-exchange-alt"></i></div>

        <!-- ✅ Texto Movimentar ao lado do ícone -->
        <h2 class="section-title inline-title">
          <span>Movimentar</span>
          <span class="mov-origem" id="movOrigemChip">
            <i class="fas fa-store"></i>
            <span id="movOrigemText">Origem: —</span>
          </span>
        </h2>
      </div>

      <!-- Boulevard + Centro (lado a lado sempre) -->
      <div class="grid-2 force-2">
        <div class="field">
          <label><i class="fas fa-building"></i> Boulevard</label>
          <input id="deltaBoulevard" inputmode="numeric" placeholder="0" />
        </div>
        <div class="field">
          <label><i class="fas fa-city"></i> Centro</label>
          <input id="deltaCentro" inputmode="numeric" placeholder="0" />
        </div>
      </div>

      <!-- Lotobel + Santa Tereza (lado a lado sempre) -->
      <div class="grid-2 force-2">
        <div class="field">
          <label><i class="fas fa-landmark"></i> Lotobel</label>
          <input id="deltaLotobel" inputmode="numeric" placeholder="0" />
        </div>
        <div class="field">
          <label><i class="fas fa-church"></i> Santa Tereza</label>
          <input id="deltaSantaTereza" inputmode="numeric" placeholder="0" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-dark" id="btnMovimentar">
          <i class="fas fa-arrows-alt-h"></i><span>Movimentar</span>
        </button>
        <button type="button" class="btn-ghost" id="btnZerarMov">
          <i class="fas fa-undo"></i><span>Limpar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal-overlay" id="modalOverlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-icon"><i class="fas fa-question-circle"></i></div>
        <h3 class="modal-title" id="modalTitle">Confirmação</h3>
      </div>
      <div class="modal-body" id="modalBody">Mensagem do modal</div>
      <div class="modal-actions">
        <button type="button" class="btn-ghost" id="modalCancel">
          <i class="fas fa-times"></i><span>Cancelar</span>
        </button>
        <button type="button" class="btn-primary" id="modalConfirm">
          <i class="fas fa-check"></i><span>Confirmar</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    /********************************************************
     * CONFIG
     ********************************************************/
    const API_URL = "https://script.google.com/macros/s/AKfycbx0-Yyh7BvhHEm40Y7I_cd_G21JsKhP-osnj6yhukVnXqUYafhkammVTSLltjrexSbC/exec";

    const LOJA_CONFIG = {
      "Boulevard":    { logo: "./icons/boulevard.jpg",    theme: "boulevard",    nome: "Boulevard",     position: "50% 50%" },
      "Centro":       { logo: "./icons/loterpraca.png",   theme: "centro",       nome: "Centro",        position: "50% 42%" }, // ajuste p/ “arvorezinha”
      "Lotobel":      { logo: "./icons/lotobel.jpg",      theme: "lotobel",      nome: "Lotobel",       position: "50% 50%" },
      "Santa Tereza": { logo: "./icons/santa-tereza.png", theme: "santa-tereza", nome: "Santa Tereza",  position: "50% 50%" }
    };

    const $ = (id) => document.getElementById(id);

    function setStatus(msg, type = "muted", icon = "info-circle") {
      const el = $("status");
      el.className = `status ${type}`;
      el.innerHTML = `<i class="fas fa-${icon}"></i><span>${msg}</span>`;
    }

    function setButtonLoading(btn, loading) {
      if (loading) { btn.classList.add("btn-loading"); btn.disabled = true; }
      else { btn.classList.remove("btn-loading"); btn.disabled = false; }
    }

    function onlyDigits(v) { return String(v || "").replace(/[^\d\-]/g, ""); }

    function parseBRMoneyToNumber(v) {
      if (v == null) return 0;
      const s = String(v).trim();
      if (!s) return 0;
      const cleaned = s.replace(/[R$\s]/g, "").replace(/\./g, "").replace(",", ".");
      const n = Number(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    function base64Json(obj) {
      const json = JSON.stringify(obj);
      return btoa(unescape(encodeURIComponent(json)));
    }

    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cbName = "cb_" + Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const sep = url.includes("?") ? "&" : "?";
        s.src = url + sep + "callback=" + cbName + "&_t=" + Date.now();

        const timer = setTimeout(() => { cleanup(); reject(new Error("Timeout na chamada da API.")); }, 25000);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cbName]; } catch (e) {}
          if (s && s.parentNode) s.parentNode.removeChild(s);
        }

        window[cbName] = (data) => { cleanup(); resolve(data); };
        s.onerror = () => { cleanup(); reject(new Error("Falha carregando JSONP (script).")); };

        document.body.appendChild(s);
      });
    }

    async function callApi(action, payloadObj) {
      const payload = base64Json(payloadObj || {});
      const url = `${API_URL}?action=${encodeURIComponent(action)}&payload=${encodeURIComponent(payload)}`;
      return await jsonp(url);
    }

    function validateBase(exigirCotas = true) {
      const lojaOrigem = $("lojaOrigem").value.trim();
      const modalidade = $("modalidade").value.trim();
      const concurso = $("concurso").value.trim();

      const dataInicial = $("dataInicial").value;
      const dataConcurso = $("dataConcurso").value;

      const qtdJogos = Number(onlyDigits($("qtdJogos").value));
      const qtdDezenas = Number(onlyDigits($("qtdDezenas").value));

      const valorCota = parseBRMoneyToNumber($("valorCota").value);
      const cotas = Number(onlyDigits($("cotas").value));

      if (!lojaOrigem) throw new Error("Loja de origem é obrigatória.");
      if (!modalidade) throw new Error("Modalidade é obrigatória.");
      if (!concurso) throw new Error("Concurso é obrigatório.");
      if (!dataInicial) throw new Error("Data inicial é obrigatória.");
      if (!dataConcurso) throw new Error("Data do concurso é obrigatória.");
      if (!qtdJogos || qtdJogos <= 0) throw new Error("Qtd de Jogos deve ser > 0.");
      if (!qtdDezenas || qtdDezenas <= 0) throw new Error("Qtd de Dezenas deve ser > 0.");
      if (!valorCota || valorCota <= 0) throw new Error("Valor da cota deve ser > 0.");
      if (exigirCotas && (!Number.isFinite(cotas) || cotas === 0)) throw new Error("Qtd de Cotas é obrigatória (≠ 0).");

      return { lojaOrigem, modalidade, concurso, dataInicial, dataConcurso, qtdJogos, qtdDezenas, valorCota, cotas };
    }

    function getMovDeltas() {
      const deltaBoulevard = Number(onlyDigits($("deltaBoulevard").value || "0")) || 0;
      const deltaCentro = Number(onlyDigits($("deltaCentro").value || "0")) || 0;
      const deltaLotobel = Number(onlyDigits($("deltaLotobel").value || "0")) || 0;
      const deltaSantaTereza = Number(onlyDigits($("deltaSantaTereza").value || "0")) || 0;
      return { deltaBoulevard, deltaCentro, deltaLotobel, deltaSantaTereza };
    }

    function saveDraft() {
      const draft = {
        lojaOrigem: $("lojaOrigem").value,
        modalidade: $("modalidade").value,
        concurso: $("concurso").value,
        dataInicial: $("dataInicial").value,
        dataConcurso: $("dataConcurso").value,
        qtdJogos: $("qtdJogos").value,
        qtdDezenas: $("qtdDezenas").value,
        cotas: $("cotas").value,
        valorCota: $("valorCota").value,
        deltaBoulevard: $("deltaBoulevard").value,
        deltaCentro: $("deltaCentro").value,
        deltaLotobel: $("deltaLotobel").value,
        deltaSantaTereza: $("deltaSantaTereza").value
      };
      localStorage.setItem("bolo_draft", JSON.stringify(draft));
    }

    function loadDraft() {
      try {
        const raw = localStorage.getItem("bolo_draft");
        if (!raw) return;
        const d = JSON.parse(raw);
        $("lojaOrigem").value = d.lojaOrigem || "";
        $("modalidade").value = d.modalidade || "";
        $("concurso").value = d.concurso || "";
        $("dataInicial").value = d.dataInicial || "";
        $("dataConcurso").value = d.dataConcurso || "";
        $("qtdJogos").value = d.qtdJogos || "";
        $("qtdDezenas").value = d.qtdDezenas || "";
        $("cotas").value = d.cotas || "";
        $("valorCota").value = d.valorCota || "";
        $("deltaBoulevard").value = d.deltaBoulevard || "";
        $("deltaCentro").value = d.deltaCentro || "";
        $("deltaLotobel").value = d.deltaLotobel || "";
        $("deltaSantaTereza").value = d.deltaSantaTereza || "";
      } catch (e) {}
    }

    function clearMain() {
      $("modalidade").value = "";
      $("concurso").value = "";
      $("dataInicial").value = "";
      $("dataConcurso").value = "";
      $("qtdJogos").value = "";
      $("qtdDezenas").value = "";
      $("cotas").value = "";
      $("valorCota").value = "";
      saveDraft();
    }

    function clearMov() {
      $("deltaBoulevard").value = "";
      $("deltaCentro").value = "";
      $("deltaLotobel").value = "";
      $("deltaSantaTereza").value = "";
      saveDraft();
    }

    function fmtBRL(n) {
      const num = Number(n || 0);
      return num.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function buildExistsConfirmText(base) {
      return [
        `Bolão da ${base.modalidade} Concurso ${base.concurso}`,
        `${base.qtdJogos} jogos de ${base.qtdDezenas} dezenas`,
        `Valor ${fmtBRL(base.valorCota)}`,
        ``,
        `Já existe.`,
        `Adicionar ${base.cotas} cotas nesse bolão?`
      ].join("\n");
    }

    function showModal(title, body, onConfirm) {
      $("modalTitle").textContent = title;
      $("modalBody").textContent = body;
      $("modalOverlay").classList.add("active");

      $("modalConfirm").onclick = () => { closeModal(); onConfirm(); };
      $("modalCancel").onclick = () => closeModal();
      $("modalOverlay").onclick = (e) => { if (e.target === $("modalOverlay")) closeModal(); };
    }
    function closeModal() { $("modalOverlay").classList.remove("active"); }

    function updateBrandActive(loja) {
      document.querySelectorAll(".brand-btn").forEach(btn => {
        btn.classList.toggle("active", btn.getAttribute("data-loja") === loja);
      });
    }

    function updateThemeAndLogo() {
      const loja = $("lojaOrigem").value;
      const config = LOJA_CONFIG[loja];
      const img = $("logoImg");

      if (config) {
        document.body.setAttribute("data-theme", config.theme);
        img.src = config.logo;
        img.alt = `Logo ${config.nome}`;
        img.style.objectPosition = config.position || "center";

        $("headerTitle").textContent = `${config.nome} • Bolões`;
        $("headerSub").textContent = "Cadastro e movimentação";
        updateBrandActive(loja);
      } else {
        document.body.removeAttribute("data-theme");
        img.src = "./icons/loterpraca.png";
        img.alt = "Loterpraça";
        img.style.objectPosition = "center";

        $("headerTitle").textContent = "Sistema de Bolões";
        $("headerSub").textContent = "Cadastro e movimentação";
        updateBrandActive("");
      }
    }

    function updateMovimentarUIByOrigem() {
      const loja = $("lojaOrigem").value.trim();
      const chip = $("movOrigemText");
      if (chip) chip.textContent = loja ? `Origem: ${loja}` : "Origem: —";

      const map = [
        { loja: "Boulevard", inputId: "deltaBoulevard" },
        { loja: "Centro", inputId: "deltaCentro" },
        { loja: "Lotobel", inputId: "deltaLotobel" },
        { loja: "Santa Tereza", inputId: "deltaSantaTereza" },
      ];

      map.forEach(({ loja: lojaName, inputId }) => {
        const el = $(inputId);
        if (!el) return;

        const shouldDisable = !!loja && loja === lojaName;
        el.disabled = shouldDisable;
        if (shouldDisable) el.value = "";
      });
    }

    /********************************************************
     * ACTIONS
     ********************************************************/
    async function onCadastrar() {
      const btn = $("btnCadastrar");
      try {
        setStatus("Enviando dados...", "muted", "spinner fa-spin");
        setButtonLoading(btn, true);

        const base = validateBase(true);
        const payload = {
          lojaOrigem: base.lojaOrigem,
          modalidade: base.modalidade,
          concurso: base.concurso,
          dataInicial: base.dataInicial,
          dataConcurso: base.dataConcurso,
          qtdJogos: base.qtdJogos,
          qtdDezenas: base.qtdDezenas,
          cotas: base.cotas,
          valorCota: base.valorCota
        };

        saveDraft();
        const res = await callApi("cadastrar", payload);

        if (res && res.code === "EXISTS") {
          showModal("Bolão já existe", buildExistsConfirmText(base), async () => {
            setStatus("Adicionando cotas...", "muted", "spinner fa-spin");
            setButtonLoading(btn, true);

            const res2 = await callApi("cadastrar", { ...payload, confirmAdd: true });

            setButtonLoading(btn, false);
            if (res2 && res2.ok) setStatus(res2.message || "Cotas adicionadas!", "ok", "check-circle");
            else setStatus((res2 && res2.message) ? res2.message : "Erro ao somar cotas.", "err", "exclamation-circle");
          });

          setButtonLoading(btn, false);
          setStatus("Aguardando confirmação...", "muted", "clock");
          return;
        }

        setButtonLoading(btn, false);
        if (res && res.ok) setStatus(res.message || "Bolão cadastrado!", "ok", "check-circle");
        else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err", "exclamation-circle");
      } catch (err) {
        setButtonLoading(btn, false);
        setStatus(err.message || String(err), "err", "exclamation-circle");
      }
    }

    async function onDeletar() {
      const loja = $("lojaOrigem").value;
      showModal(
        "Confirmar deleção",
        `Deletar o bolão em ${loja}?\n\nEssa ação não pode ser desfeita.`,
        async () => {
          const btn = $("btnDeletar");
          try {
            setStatus("Deletando bolão...", "muted", "spinner fa-spin");
            setButtonLoading(btn, true);

            const base = validateBase(false);
            const payload = {
              lojaOrigem: base.lojaOrigem,
              modalidade: base.modalidade,
              concurso: base.concurso,
              dataInicial: base.dataInicial,
              dataConcurso: base.dataConcurso,
              qtdJogos: Number(onlyDigits($("qtdJogos").value)) || 1,
              qtdDezenas: Number(onlyDigits($("qtdDezenas").value)) || 1,
              cotas: -999,
              valorCota: base.valorCota
            };

            saveDraft();
            const res = await callApi("cadastrar", payload);

            setButtonLoading(btn, false);
            if (res && res.ok) setStatus(res.message || "Bolão deletado!", "ok", "check-circle");
            else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err", "exclamation-circle");
          } catch (err) {
            setButtonLoading(btn, false);
            setStatus(err.message || String(err), "err", "exclamation-circle");
          }
        }
      );
    }

    async function onMovimentar() {
      const btn = $("btnMovimentar");
      try {
        setStatus("Enviando movimentação...", "muted", "spinner fa-spin");
        setButtonLoading(btn, true);

        const base = validateBase(false);
        const deltas = getMovDeltas();

        if (!deltas.deltaBoulevard && !deltas.deltaCentro && !deltas.deltaLotobel && !deltas.deltaSantaTereza) {
          throw new Error("Informe pelo menos um destino com valor diferente de zero.");
        }

        const payload = {
          lojaOrigem: base.lojaOrigem,
          modalidade: base.modalidade,
          concurso: base.concurso,
          dataInicial: base.dataInicial,
          dataConcurso: base.dataConcurso,
          qtdJogos: Number(onlyDigits($("qtdJogos").value)),
          qtdDezenas: Number(onlyDigits($("qtdDezenas").value)),
          valorCota: base.valorCota,
          deltaBoulevard: deltas.deltaBoulevard,
          deltaCentro: deltas.deltaCentro,
          deltaLotobel: deltas.deltaLotobel,
          deltaSantaTereza: deltas.deltaSantaTereza
        };

        saveDraft();
        const res = await callApi("movimentar", payload);

        setButtonLoading(btn, false);
        if (res && res.ok) { setStatus(res.message || "Movimentação feita!", "ok", "check-circle"); clearMov(); }
        else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err", "exclamation-circle");
      } catch (err) {
        setButtonLoading(btn, false);
        setStatus(err.message || String(err), "err", "exclamation-circle");
      }
    }

    function bind() {
      document.querySelectorAll("input,select").forEach(el => {
        el.addEventListener("change", saveDraft);
        el.addEventListener("keyup", saveDraft);
      });

      $("lojaOrigem").addEventListener("change", () => {
        updateThemeAndLogo();
        updateMovimentarUIByOrigem();
        saveDraft();
      });

      document.querySelectorAll(".brand-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const loja = btn.getAttribute("data-loja");
          $("lojaOrigem").value = loja;
          updateThemeAndLogo();
          updateMovimentarUIByOrigem();
          saveDraft();
        });
      });

      $("btnCadastrar").addEventListener("click", onCadastrar);
      $("btnDeletar").addEventListener("click", onDeletar);
      $("btnMovimentar").addEventListener("click", onMovimentar);

      $("btnLimpar").addEventListener("click", () => {
        clearMain();
        setStatus("Campos principais limpos.", "muted", "broom");
      });

      $("btnZerarMov").addEventListener("click", () => {
        clearMov();
        setStatus("Movimentação limpa.", "muted", "broom");
      });
    }

    // Init
    loadDraft();
    bind();
    updateThemeAndLogo();
    updateMovimentarUIByOrigem();
  </script>

  <!-- Service Worker -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js");
      });
    }
  </script>
</body>
</html>
