<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --txt:#111827;
      --muted:#6b7280;
      --label:#111827;
      --line:#e5e7eb;
      --btn:#111827;
      --btn2:#2563eb;
      --danger:#dc2626;
      --shadow:0 10px 25px rgba(0,0,0,.07);
      --radius:16px;
      --pad:14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:var(--font); color:var(--txt); background:var(--bg); }
    .wrap{ max-width:920px; margin:0 auto; padding:14px 12px 90px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--pad); margin:10px 0; }

    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .row2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .mov-origem{
      display:inline-block;
      margin-left:8px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      font-weight:800;
      color:#111827;
    }

    input:disabled{
      background:#f3f4f6;
      color:#9ca3af;
      cursor:not-allowed;
    }

    .field label{
      display:block;
      font-size:12px;
      color:var(--label);
      font-weight:800;
      margin:0 0 6px 2px;
    }
    .field input, .field select{
      width:100%;
      font-size:16px;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      outline:none;
      background:#fff;
    }
    .field input:focus, .field select:focus{
      border-color:#93c5fd;
      box-shadow:0 0 0 3px rgba(59,130,246,.15);
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .actions-3{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    button{
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      min-height:46px;
    }
    .btn-primary{ background:var(--btn2); color:#fff; }
    .btn-dark{ background:var(--btn); color:#fff; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-ghost{ background:#fff; border:1px solid var(--line); color:var(--txt); }

    .status{
      margin-top:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px dashed var(--line);
      background:#fff;
      font-size:14px;
      line-height:1.35;
      white-space:pre-line;
    }
    .ok{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.06); }
    .err{ border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.06); }
    .muted{ color:var(--muted); }

    .sectionTitle{ font-size:14px; font-weight:900; margin:0 0 10px; }

    @media (max-width:720px){
      .grid{ grid-template-columns: 1fr; }
      .field input, .field select{ font-size:17px; }
      button{ font-size:17px; }
      /* row2 continua 2 colunas */
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- CARD: DADOS -->
    <div class="card">
      <p class="sectionTitle">Dados do bolão</p>

      <div class="grid">
        <div class="field">
          <label>Loja de origem</label>
          <select id="lojaOrigem" required>
            <option value="">Selecione…</option>
            <option>Centro</option>
            <option>Lotobel</option>
            <option>Boulevard</option>
            <option>Santa Tereza</option>
          </select>
        </div>

        <div class="field">
          <label>Modalidade</label>
          <select id="modalidade" required>
            <option value="">Selecione…</option>
            <option>Mega Sena</option>
            <option>Lotofacil</option>
            <option>Quina</option>
            <option>Dupla Sena</option>
            <option>Dia de Sorte</option>
            <option>Super Sete</option>
            <option>Milionaria</option>
            <option>Timemania</option>
            <option>Lotomania</option>
            <option>Federal</option>
            <option>Pascoa</option>
            <option>Sao Joao</option>
            <option>Independencia</option>
            <option>Virada</option>
          </select>
        </div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Concurso</label>
          <input id="concurso" inputmode="numeric" required />
        </div>
        <div></div>
      </div>

      <!-- Datas SEMPRE lado a lado -->
      <div class="row2">
        <div class="field">
          <label>Data inicial</label>
          <input id="dataInicial" type="date" required />
        </div>
        <div class="field">
          <label>Data do concurso</label>
          <input id="dataConcurso" type="date" required />
        </div>
      </div>

      <!-- Jogos + dezenas -->
      <div class="row2" style="margin-top:10px;">
        <div class="field">
          <label>Qtd de Jogos</label>
          <input id="qtdJogos" inputmode="numeric" required />
        </div>
        <div class="field">
          <label>Qtd de Dezenas</label>
          <input id="qtdDezenas" inputmode="numeric" required />
        </div>
      </div>

      <!-- Valor + cotas -->
      <div class="row2" style="margin-top:10px;">
        <div class="field">
          <label>Valor da cota (R$)</label>
          <input id="valorCota" inputmode="decimal" required />
        </div>
        <div class="field">
          <label>Qtde de Cotas</label>
          <input id="cotas" inputmode="numeric" required />
        </div>
      </div>

      <div class="actions actions-3">
        <button type="button" class="btn-primary" id="btnCadastrar">Cadastrar</button>
        <button type="button" class="btn-ghost" id="btnLimpar">Limpar</button>
        <button type="button" class="btn-danger" id="btnDeletar" title="Deleta o bolão (envia -999)">Deletar</button>
      </div>

      <div id="status" class="status muted">Pronto.</div>
    </div>

    <!-- CARD: MOVIMENTAR -->
    <div class="card">
      <p class="sectionTitle">
        Movimentar (Controle) <span class="mov-origem" id="movOrigemChip">Origem: —</span>
      </p>

      <div class="grid">
        <div class="field">
          <label>Boulevard</label>
          <input id="deltaBoulevard" inputmode="numeric" />
        </div>
        <div class="field">
          <label>Centro</label>
          <input id="deltaCentro" inputmode="numeric" />
        </div>
      </div>

      <div class="grid" style="margin-top:10px;">
        <div class="field">
          <label>Lotobel</label>
          <input id="deltaLotobel" inputmode="numeric" />
        </div>
        <div class="field">
          <label>Santa Tereza</label>
          <input id="deltaSantaTereza" inputmode="numeric" />
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn-dark" id="btnMovimentar">Movimentar</button>
        <button type="button" class="btn-ghost" id="btnZerarMov">Limpar</button>
      </div>
    </div>

  </div>

<script>
  /********************************************************
   * CONFIG
   ********************************************************/
  const API_URL = "https://script.google.com/macros/s/AKfycbxF9oRHS4PbB7gPXVO32OyTywvgm16ELRcAFnC-1Y56DUuntcKp9sidhqhKqbSMdn96/exec";

  /********************************************************
   * HELPERS
   ********************************************************/
  const $ = (id) => document.getElementById(id);

  function setStatus(msg, type="muted"){
    const el = $("status");
    el.classList.remove("ok","err","muted");
    el.classList.add(type);
    el.textContent = msg;
  }

  function onlyDigits(v){ return String(v||"").replace(/[^\d\-]/g,""); }

  function parseBRMoneyToNumber(v){
    if (v == null) return 0;
    const s = String(v).trim();
    if (!s) return 0;
    const cleaned = s.replace(/[R$\s]/g,"").replace(/\./g,"").replace(",",".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function base64Json(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }

  // JSONP + cache-busting
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName + "&_t=" + Date.now();

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout na chamada da API."));
      }, 25000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("Falha carregando JSONP (script).")); };

      document.body.appendChild(s);
    });
  }

  async function callApi(action, payloadObj){
    const payload = base64Json(payloadObj || {});
    const url = `${API_URL}?action=${encodeURIComponent(action)}&payload=${encodeURIComponent(payload)}`;
    return await jsonp(url);
  }

  function validateBase(exigirCotas=true){
    const lojaOrigem = $("lojaOrigem").value.trim();
    const modalidade = $("modalidade").value.trim();
    const concurso = $("concurso").value.trim();

    const dataInicial = $("dataInicial").value;
    const dataConcurso = $("dataConcurso").value;

    const qtdJogos = Number(onlyDigits($("qtdJogos").value));
    const qtdDezenas = Number(onlyDigits($("qtdDezenas").value));

    const valorCota = parseBRMoneyToNumber($("valorCota").value);
    const cotas = Number(onlyDigits($("cotas").value));

    if(!lojaOrigem) throw new Error("Loja de origem é obrigatória.");
    if(!modalidade) throw new Error("Modalidade é obrigatória.");
    if(!concurso) throw new Error("Concurso é obrigatório.");
    if(!dataInicial) throw new Error("Data inicial é obrigatória.");
    if(!dataConcurso) throw new Error("Data do concurso é obrigatória.");
    if(!qtdJogos || qtdJogos <= 0) throw new Error("Qtd de Jogos deve ser > 0.");
    if(!qtdDezenas || qtdDezenas <= 0) throw new Error("Qtd de Dezenas deve ser > 0.");
    if(!valorCota || valorCota <= 0) throw new Error("Valor da cota deve ser > 0.");
    if(exigirCotas && (!Number.isFinite(cotas) || cotas === 0)) throw new Error("Qtde de Cotas é obrigatória (≠ 0).");

    return { lojaOrigem, modalidade, concurso, dataInicial, dataConcurso, qtdJogos, qtdDezenas, valorCota, cotas };
  }

  function getMovDeltas(){
    const deltaBoulevard = Number(onlyDigits($("deltaBoulevard").value || "0")) || 0;
    const deltaCentro = Number(onlyDigits($("deltaCentro").value || "0")) || 0;
    const deltaLotobel = Number(onlyDigits($("deltaLotobel").value || "0")) || 0;
    const deltaSantaTereza = Number(onlyDigits($("deltaSantaTereza").value || "0")) || 0;
    return { deltaBoulevard, deltaCentro, deltaLotobel, deltaSantaTereza };
  }

  // Draft local
  function saveDraft(){
    const draft = {
      lojaOrigem: $("lojaOrigem").value,
      modalidade: $("modalidade").value,
      concurso: $("concurso").value,
      dataInicial: $("dataInicial").value,
      dataConcurso: $("dataConcurso").value,
      qtdJogos: $("qtdJogos").value,
      qtdDezenas: $("qtdDezenas").value,
      cotas: $("cotas").value,
      valorCota: $("valorCota").value,
      deltaBoulevard: $("deltaBoulevard").value,
      deltaCentro: $("deltaCentro").value,
      deltaLotobel: $("deltaLotobel").value,
      deltaSantaTereza: $("deltaSantaTereza").value
    };
    localStorage.setItem("bolo_draft", JSON.stringify(draft));
  }

  function loadDraft(){
    try{
      const raw = localStorage.getItem("bolo_draft");
      if(!raw) return;
      const d = JSON.parse(raw);
      $("lojaOrigem").value = d.lojaOrigem || "";
      $("modalidade").value = d.modalidade || "";
      $("concurso").value = d.concurso || "";
      $("dataInicial").value = d.dataInicial || "";
      $("dataConcurso").value = d.dataConcurso || "";
      $("qtdJogos").value = d.qtdJogos || "";
      $("qtdDezenas").value = d.qtdDezenas || "";
      $("cotas").value = d.cotas || "";
      $("valorCota").value = d.valorCota || "";
      $("deltaBoulevard").value = d.deltaBoulevard || "";
      $("deltaCentro").value = d.deltaCentro || "";
      $("deltaLotobel").value = d.deltaLotobel || "";
      $("deltaSantaTereza").value = d.deltaSantaTereza || "";
    }catch(e){}
  }

  function clearMain(){
    $("modalidade").value = "";
    $("concurso").value = "";
    $("dataInicial").value = "";
    $("dataConcurso").value = "";
    $("qtdJogos").value = "";
    $("qtdDezenas").value = "";
    $("cotas").value = "";
    $("valorCota").value = "";
    saveDraft();
  }

  function clearMov(){
    $("deltaBoulevard").value = "";
    $("deltaCentro").value = "";
    $("deltaLotobel").value = "";
    $("deltaSantaTereza").value = "";
    saveDraft();
  }

  function fmtBRL(n){
    const num = Number(n || 0);
    return num.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  function buildExistsConfirmText(base, currentCotas){
    return [
      `Bolão da ${base.modalidade} Concurso ${base.concurso}`,
      `${base.qtdJogos} jogos de ${base.qtdDezenas} dezenas`,
      `Valor ${fmtBRL(base.valorCota)}`,
      ``,
      `Já existe.`,
      `Gostaria de adicionar ${base.cotas} cotas nesse bolão?`
    ].join("\n");
  }

  /********************************************************
   * ACTIONS
   ********************************************************/
  async function onCadastrar(){
    try{
      setStatus("Enviando…");
      const base = validateBase(true);

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: base.qtdJogos,
        qtdDezenas: base.qtdDezenas,
        cotas: base.cotas,
        valorCota: base.valorCota
      };

      saveDraft();
      const res = await callApi("cadastrar", payload);

      // confirmação formatada
      if(res && res.code === "EXISTS"){
        const txt = buildExistsConfirmText(base, res.currentCotas || 0);
        const ok = confirm(txt);
        if(!ok){
          setStatus("Operação cancelada.", "muted");
          return;
        }
        const res2 = await callApi("cadastrar", { ...payload, confirmAdd: true });
        if(res2 && res2.ok) setStatus(res2.message || "OK! (cotas somadas)", "ok");
        else setStatus((res2 && res2.message) ? res2.message : "Erro ao somar cotas.", "err");
        return;
      }

      if(res && res.ok) setStatus(res.message || "OK!", "ok");
      else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onDeletar(){
    try{
      setStatus("Enviando deleção…");
      const base = validateBase(false);

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: Number(onlyDigits($("qtdJogos").value)) || 1,
        qtdDezenas: Number(onlyDigits($("qtdDezenas").value)) || 1,
        cotas: -999,
        valorCota: base.valorCota
      };

      saveDraft();
      const res = await callApi("cadastrar", payload);

      if(res && res.ok) setStatus(res.message || "OK!", "ok");
      else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onMovimentar(){
    try{
      setStatus("Enviando movimentação…");
      const base = validateBase(false);
      const deltas = getMovDeltas();

      if(!deltas.deltaBoulevard && !deltas.deltaCentro && !deltas.deltaLotobel && !deltas.deltaSantaTereza){
        throw new Error("Informe pelo menos um destino com valor diferente de zero.");
      }

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: Number(onlyDigits($("qtdJogos").value)),
        qtdDezenas: Number(onlyDigits($("qtdDezenas").value)),
        valorCota: base.valorCota,
        deltaBoulevard: deltas.deltaBoulevard,
        deltaCentro: deltas.deltaCentro,
        deltaLotobel: deltas.deltaLotobel,
        deltaSantaTereza: deltas.deltaSantaTereza
      };

      saveDraft();
      const res = await callApi("movimentar", payload);

      if(res && res.ok){
        setStatus(res.message || "OK!", "ok");
        clearMov();
      }else{
        setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
      }
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  function updateMovimentarUIByOrigem(){
    const origemEl = $("lojaOrigem");
    const chip = $("movOrigemChip");
    if (!origemEl || !chip) return;

    const origem =
      (origemEl.selectedOptions?.[0]?.text || "").trim() ||
      (origemEl.value || "").trim();

    chip.textContent = `Origem: ${origem || "—"}`;

    const map = [
      { loja: "Boulevard",    inputId: "deltaBoulevard" },
      { loja: "Centro",       inputId: "deltaCentro" },
      { loja: "Lotobel",      inputId: "deltaLotobel" },
      { loja: "Santa Tereza", inputId: "deltaSantaTereza" },
    ];

    map.forEach(({ loja, inputId }) => {
      const el = $(inputId);
      if (!el) return;

      const shouldDisable = !!origem && origem === loja;
      el.disabled = shouldDisable;
      if (shouldDisable) el.value = "";
    });
  }

  /********************************************************
   * INIT
   ********************************************************/
  function bind(){
    document.querySelectorAll("input,select").forEach(el => {
      el.addEventListener("change", saveDraft);
      el.addEventListener("keyup", saveDraft);
    });

    $("lojaOrigem").addEventListener("change", () => {
      updateMovimentarUIByOrigem();
      saveDraft();
    });

    $("btnCadastrar").addEventListener("click", onCadastrar);

    $("btnDeletar").addEventListener("click", async () => {
      const loja = $("lojaOrigem").value;
      const ok = confirm(`Confirmar deleção do bolão em ${loja}?`);
      if (!ok) return;
      await onDeletar();
    });

    $("btnMovimentar").addEventListener("click", onMovimentar);

    $("btnLimpar").addEventListener("click", () => { clearMain(); setStatus("Campos limpos.", "muted"); });
    $("btnZerarMov").addEventListener("click", () => { clearMov(); setStatus("Movimentação zerada.", "muted"); });
  }

  loadDraft();
  bind();
  updateMovimentarUIByOrigem();
</script>

</body>
</html>
