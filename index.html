<script>
  /********************************************************
   * CONFIG
   ********************************************************/
  const API_URL = "https://script.google.com/macros/s/AKfycbyXPMgPaSK5Iew87JnNqsPfqEWbVxtAqZbgIlGAeyyoZDqW3WB3GQ9zFHmQVHYXldc/exec";

  /********************************************************
   * HELPERS
   ********************************************************/
  const $ = (id) => document.getElementById(id);

  function setStatus(msg, type="muted"){
    const el = $("status");
    el.classList.remove("ok","err","muted");
    el.classList.add(type);
    el.textContent = msg;
  }

  function onlyDigits(v){ return String(v||"").replace(/[^\d\-]/g,""); }

  function parseBRMoneyToNumber(v){
    if (v == null) return 0;
    const s = String(v).trim();
    if (!s) return 0;
    const cleaned = s.replace(/[R$\s]/g,"").replace(/\./g,"").replace(",",".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : 0;
  }

  function base64Json(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }

  // JSONP + cache-busting
  function jsonp(url){
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Math.random().toString(36).slice(2);
      const s = document.createElement("script");
      const sep = url.includes("?") ? "&" : "?";
      s.src = url + sep + "callback=" + cbName + "&_t=" + Date.now();

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("Timeout na chamada da API."));
      }, 25000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cbName] = (data) => { cleanup(); resolve(data); };
      s.onerror = () => { cleanup(); reject(new Error("Falha carregando JSONP (script).")); };

      document.body.appendChild(s);
    });
  }

  async function callApi(action, payloadObj){
    const payload = base64Json(payloadObj || {});
    const url = `${API_URL}?action=${encodeURIComponent(action)}&payload=${encodeURIComponent(payload)}`;
    return await jsonp(url);
  }

  function validateBase(exigirCotas=true){
    const lojaOrigem = $("lojaOrigem").value.trim();
    const modalidade = $("modalidade").value.trim();
    const concurso = $("concurso").value.trim();

    const dataInicial = $("dataInicial").value;
    const dataConcurso = $("dataConcurso").value;

    const qtdJogos = Number(onlyDigits($("qtdJogos").value));
    const qtdDezenas = Number(onlyDigits($("qtdDezenas").value));

    const valorCota = parseBRMoneyToNumber($("valorCota").value);
    const cotas = Number(onlyDigits($("cotas").value));

    if(!lojaOrigem) throw new Error("Loja de origem é obrigatória.");
    if(!modalidade) throw new Error("Modalidade é obrigatória.");
    if(!concurso) throw new Error("Concurso é obrigatório.");
    if(!dataInicial) throw new Error("Data inicial é obrigatória.");
    if(!dataConcurso) throw new Error("Data do concurso é obrigatória.");
    if(!qtdJogos || qtdJogos <= 0) throw new Error("Qtd de Jogos deve ser > 0.");
    if(!qtdDezenas || qtdDezenas <= 0) throw new Error("Qtd de Dezenas deve ser > 0.");
    if(!valorCota || valorCota <= 0) throw new Error("Valor da cota deve ser > 0.");
    if(exigirCotas && (!Number.isFinite(cotas) || cotas === 0)) throw new Error("Qtde de Cotas é obrigatória (≠ 0).");

    return { lojaOrigem, modalidade, concurso, dataInicial, dataConcurso, qtdJogos, qtdDezenas, valorCota, cotas };
  }

  function getMovDeltas(){
    const deltaBoulevard = Number(onlyDigits($("deltaBoulevard").value || "0")) || 0;
    const deltaCentro = Number(onlyDigits($("deltaCentro").value || "0")) || 0;
    const deltaLotobel = Number(onlyDigits($("deltaLotobel").value || "0")) || 0;
    const deltaSantaTereza = Number(onlyDigits($("deltaSantaTereza").value || "0")) || 0;
    return { deltaBoulevard, deltaCentro, deltaLotobel, deltaSantaTereza };
  }

  // Draft local
  function saveDraft(){
    const draft = {
      lojaOrigem: $("lojaOrigem").value,
      modalidade: $("modalidade").value,
      concurso: $("concurso").value,
      dataInicial: $("dataInicial").value,
      dataConcurso: $("dataConcurso").value,
      qtdJogos: $("qtdJogos").value,
      qtdDezenas: $("qtdDezenas").value,
      cotas: $("cotas").value,
      valorCota: $("valorCota").value,
      deltaBoulevard: $("deltaBoulevard").value,
      deltaCentro: $("deltaCentro").value,
      deltaLotobel: $("deltaLotobel").value,
      deltaSantaTereza: $("deltaSantaTereza").value
    };
    localStorage.setItem("bolo_draft", JSON.stringify(draft));
  }

  function loadDraft(){
    try{
      const raw = localStorage.getItem("bolo_draft");
      if(!raw) return;
      const d = JSON.parse(raw);
      $("lojaOrigem").value = d.lojaOrigem || "";
      $("modalidade").value = d.modalidade || "";
      $("concurso").value = d.concurso || "";
      $("dataInicial").value = d.dataInicial || "";
      $("dataConcurso").value = d.dataConcurso || "";
      $("qtdJogos").value = d.qtdJogos || "";
      $("qtdDezenas").value = d.qtdDezenas || "";
      $("cotas").value = d.cotas || "";
      $("valorCota").value = d.valorCota || "";
      $("deltaBoulevard").value = d.deltaBoulevard || "";
      $("deltaCentro").value = d.deltaCentro || "";
      $("deltaLotobel").value = d.deltaLotobel || "";
      $("deltaSantaTereza").value = d.deltaSantaTereza || "";
    }catch(e){}
  }

  function clearMain(){
    $("modalidade").value = "";
    $("concurso").value = "";
    $("dataInicial").value = "";
    $("dataConcurso").value = "";
    $("qtdJogos").value = "";
    $("qtdDezenas").value = "";
    $("cotas").value = "";
    $("valorCota").value = "";
    saveDraft();
  }

  function clearMov(){
    $("deltaBoulevard").value = "";
    $("deltaCentro").value = "";
    $("deltaLotobel").value = "";
    $("deltaSantaTereza").value = "";
    saveDraft();
  }

  function fmtBRL(n){
    const num = Number(n || 0);
    return num.toLocaleString("pt-BR", { style:"currency", currency:"BRL" });
  }

  function buildExistsConfirmText(base, currentCotas){
    // exatamente como você pediu: linhas separadas
    return [
      `Bolão da ${base.modalidade} Concurso ${base.concurso}`,
      `${base.qtdJogos} jogos de ${base.qtdDezenas} dezenas`,
      `Valor ${fmtBRL(base.valorCota)}`,
      ``,
      `Já existe.`,
      `Gostaria de adicionar ${base.cotas} cotas nesse bolão?`,
      `Saldo atual: ${currentCotas} | Novo saldo: ${Number(currentCotas) + Number(base.cotas)}`
    ].join("\n");
  }

  /********************************************************
   * ACTIONS
   ********************************************************/
  async function onCadastrar(){
    try{
      setStatus("Enviando…");
      const base = validateBase(true);

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: base.qtdJogos,
        qtdDezenas: base.qtdDezenas,
        cotas: base.cotas,
        valorCota: base.valorCota
      };

      saveDraft();
      const res = await callApi("cadastrar", payload);

      // >>> AQUI: confirmação formatada do jeito que você pediu <<<
      if(res && res.code === "EXISTS"){
        const txt = buildExistsConfirmText(base, res.currentCotas || 0);
        const ok = confirm(txt);
        if(!ok){
          setStatus("Operação cancelada.", "muted");
          return;
        }

        const res2 = await callApi("cadastrar", { ...payload, confirmAdd: true });
        if(res2 && res2.ok) setStatus(res2.message || "OK! (cotas somadas)", "ok");
        else setStatus((res2 && res2.message) ? res2.message : "Erro ao somar cotas.", "err");
        return;
      }

      if(res && res.ok) setStatus(res.message || "OK!", "ok");
      else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onDeletar(){
    try{
      setStatus("Enviando deleção…");
      const base = validateBase(false);

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: Number(onlyDigits($("qtdJogos").value)) || 1,
        qtdDezenas: Number(onlyDigits($("qtdDezenas").value)) || 1,
        cotas: -999,
        valorCota: base.valorCota
      };

      saveDraft();
      const res = await callApi("cadastrar", payload);

      if(res && res.ok) setStatus(res.message || "OK!", "ok");
      else setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  async function onMovimentar(){
    try{
      setStatus("Enviando movimentação…");
      const base = validateBase(false);
      const deltas = getMovDeltas();

      if(!deltas.deltaBoulevard && !deltas.deltaCentro && !deltas.deltaLotobel && !deltas.deltaSantaTereza){
        throw new Error("Informe pelo menos um destino com valor diferente de zero.");
      }

      const payload = {
        lojaOrigem: base.lojaOrigem,
        modalidade: base.modalidade,
        concurso: base.concurso,
        dataInicial: base.dataInicial,
        dataConcurso: base.dataConcurso,
        qtdJogos: Number(onlyDigits($("qtdJogos").value)),
        qtdDezenas: Number(onlyDigits($("qtdDezenas").value)),
        valorCota: base.valorCota,
        deltaBoulevard: deltas.deltaBoulevard,
        deltaCentro: deltas.deltaCentro,
        deltaLotobel: deltas.deltaLotobel,
        deltaSantaTereza: deltas.deltaSantaTereza
      };

      saveDraft();
      const res = await callApi("movimentar", payload);

      if(res && res.ok){
        setStatus(res.message || "OK!", "ok");
        clearMov();
      }else{
        setStatus((res && res.message) ? res.message : "Erro desconhecido.", "err");
      }
    }catch(err){
      setStatus(err.message || String(err), "err");
    }
  }

  function updateMovimentarUIByOrigem(){
    const origemEl = $("lojaOrigem");
    const chip = $("movOrigemChip");
    if (!origemEl || !chip) return;

    const origem =
      (origemEl.selectedOptions?.[0]?.text || "").trim() ||
      (origemEl.value || "").trim();

    chip.textContent = `Origem: ${origem || "—"}`;

    const map = [
      { loja: "Boulevard",    inputId: "deltaBoulevard" },
      { loja: "Centro",       inputId: "deltaCentro" },
      { loja: "Lotobel",      inputId: "deltaLotobel" },
      { loja: "Santa Tereza", inputId: "deltaSantaTereza" },
    ];

    map.forEach(({ loja, inputId }) => {
      const el = $(inputId);
      if (!el) return;

      const shouldDisable = !!origem && origem === loja;
      el.disabled = shouldDisable;
      if (shouldDisable) el.value = "";
    });
  }

  /********************************************************
   * INIT
   ********************************************************/
  function bind(){
    document.querySelectorAll("input,select").forEach(el => {
      el.addEventListener("change", saveDraft);
      el.addEventListener("keyup", saveDraft);
    });

    $("lojaOrigem").addEventListener("change", () => {
      updateMovimentarUIByOrigem();
      saveDraft();
    });

    $("btnCadastrar").addEventListener("click", onCadastrar);

    $("btnDeletar").addEventListener("click", async () => {
      const loja = $("lojaOrigem").value;
      const ok = confirm(`Confirmar deleção do bolão em ${loja}?`);
      if (!ok) return;
      await onDeletar();
    });

    $("btnMovimentar").addEventListener("click", onMovimentar);

    $("btnLimpar").addEventListener("click", () => { clearMain(); setStatus("Campos limpos.", "muted"); });
    $("btnZerarMov").addEventListener("click", () => { clearMov(); setStatus("Movimentação zerada.", "muted"); });
  }

  loadDraft();
  bind();
  updateMovimentarUIByOrigem();

  // SW (opcional)
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", async () => {
      try {
        const reg = await navigator.serviceWorker.register("./service-worker.js", { updateViaCache: "none" });
        await reg.update();
      } catch (e) {}
    });
  }
</script>
